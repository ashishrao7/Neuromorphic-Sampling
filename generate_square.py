import numpy as np
import matplotlib.pyplot as plt
import math
import cv2
from cv2 import VideoWriter, VideoWriter_fourcc

def gkern(l=35, sig=2.5):
    """
    creates gaussian kernel with side length l and a sigma of sig
    """

    ax = np.arange(-l // 2 + 1., l // 2 + 1.)
    xx, yy = np.meshgrid(ax, ax)
    kernel = np.exp(-0.5 * (np.square(xx) + np.square(yy)) / np.square(sig))
    return kernel / np.sum(kernel)

def sampling_square():

    square_pattern = [[ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255],
                      [ 255, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 255],
                      [ 255, 240, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 240, 255],
                      [ 255, 240, 225, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  75,  75,  75,  75,  75,  75,  75,  75,  75,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  60,  60,  60,  60,  60,  60,  60,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  45,  45,  45,  45,  45,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  30,  30,  30,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,  15,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,  15,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  30,  30,  30,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  45,  45,  45,  45,  45,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  60,  60,  60,  60,  60,  60,  60,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  75,  75,  75,  75,  75,  75,  75,  75,  75,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 225, 240, 255],
                      [ 255, 240, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 240, 255],
                      [ 255, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 255],
                      [ 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255]]

            
    '''square_pattern = [[ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255],
                      [ 255, 240, 225, 210, 195, 180, 165, 150, 135, 120, 105,  90,  75,  60,  45,  30,  15,   0,  15,  30,  45,  60,  75,  90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255]]'''          
                      

    #square_pattern = gkern()*10000
    pattern=np.array(square_pattern, dtype=np.uint8)
    
    plt.imshow(pattern, cmap='gray')
    plt.axis('off')
    plt.show()

    cv2.imwrite("Images/sampling_pattern_single_channel.png", pattern)
    cv2.imwrite("Images/sampling_pattern.png", cv2.cvtColor(pattern,cv2.COLOR_GRAY2RGB))
    return pattern

def background():
    bckgd = 255 * np.ones((260, 346), dtype=np.uint8)
    cv2.imwrite("Images/background_single_channel.png", bckgd)
    cv2.imwrite("Images/background.png", cv2.cvtColor(bckgd,cv2.COLOR_GRAY2RGB))
    return bckgd

def original_image(pattern):
    pass

def move_image_on_background(pattern, background):
    '''
    The function creates a video of the pattern moving horizontally over a given background

    Parameters:
    -----------
    pattern: <np.array, 35x35>
        The pattern supposed to move over the background
    background: <np.array, 260x346>
        A white background of the given size 
    '''
    fourcc = VideoWriter_fourcc(*'HFYU')
    video = VideoWriter('./videos/moving_pattern_for_sampling_exp.avi', fourcc, 30, (346, 260))
    background[112:147, 0:35] = pattern
    frame = background
    count = 0

    for _ in range(0, 346-34):

        cv2.imwrite("video_images/frame%04d.png" % count, cv2.cvtColor(frame,cv2.COLOR_GRAY2RGB))
        video.write(cv2.cvtColor(frame,cv2.COLOR_GRAY2RGB))
        shifted_frame =  np.roll(frame, 1, axis=1)
        frame = shifted_frame
        video.write(frame)
        count+=1

    cv2.destroyAllWindows()
    video.release()
        

def main():
    pattern = sampling_square()
    bckgd = background()
    move_image_on_background(pattern, bckgd)


if __name__=='__main__':
    main()